---
import travel from '../data/travel.json';
import { feature } from 'topojson-client';
import { geoAlbersUsa, geoPath } from 'd3-geo';
import states from 'us-atlas/states-10m.json';

const totalStates = 51; // 50 states + DC
const visitedCount = travel.usStatesVisited.length;
const progressPercent = Math.round((visitedCount / totalStates) * 100);

const statesGeo = feature(states, states.objects.states);
const width = 975;
const height = 610;
const projection = geoAlbersUsa().fitSize([width, height], statesGeo);
const path = geoPath(projection);

const visitedFips = new Set(travel.usStatesVisited.map((s) => s.fips));

// Filter out territories (FIPS >= 60) for display
const usFeatures = statesGeo.features.filter((geo) => Number(geo.id) < 60);

const allStates = usFeatures
  .map((geo) => ({
    fips: geo.id,
    name: geo.properties.name,
    visited: visitedFips.has(geo.id),
  }))
  .sort((a, b) => a.name.localeCompare(b.name));
---

<section class="card us-state-map">
  <div class="flex flex-col gap-6">
    <div class="flex flex-col gap-2">
      <p class="text-sm uppercase tracking-[0.25em] text-text-muted">United States</p>
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <h2 class="text-3xl md:text-4xl font-heading font-bold">States explored</h2>
        <div class="text-sm text-text-muted">
          {visitedCount} of {totalStates} states visited ({progressPercent}%)
        </div>
      </div>
      <div class="progress-track">
        <div class="progress-fill" style={`width: ${progressPercent}%;`}></div>
      </div>
    </div>

    <div class="state-map-shell" data-us-state-map>
      <svg
        class="state-map-svg"
        viewBox={`0 0 ${width} ${height}`}
        preserveAspectRatio="xMidYMid meet"
        role="img"
        aria-label="US map showing visited states"
      >
        <g class="state-map-paths">
          {usFeatures.map((geo) => {
            const d = path(geo);
            if (!d) return null;
            return (
              <path
                d={d}
                class:list={[
                  'state-path',
                  visitedFips.has(geo.id) && 'is-visited',
                ]}
                data-state={geo.id}
                data-name={geo.properties.name}
              />
            );
          })}
        </g>
      </svg>
      <div class="state-map-label" data-state-label aria-hidden="true"></div>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2 text-sm">
      {allStates.map((state) => (
        <div class:list={[
          'flex items-center gap-1.5 px-2 py-1.5 rounded-lg',
          state.visited ? 'text-text' : 'text-text-muted opacity-40',
        ]}>
          <span class:list={[
            'w-2 h-2 rounded-full flex-shrink-0',
          ]} style={state.visited ? 'background: var(--color-primary);' : 'background: var(--color-surface-hover);'}></span>
          <span class="truncate">{state.name}</span>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .us-state-map {
    --map-visited: var(--color-primary);
    --map-visited-soft: rgba(99, 102, 241, 0.55);
    --map-unvisited: #171717;
    --map-unvisited-hover: #202020;
    --map-stroke: rgba(255, 255, 255, 0.06);
  }

  .progress-track {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: var(--color-surface-hover);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    transition: width 0.6s ease;
  }

  .state-map-shell {
    position: relative;
    border-radius: 16px;
    background:
      radial-gradient(circle at top, rgba(99, 102, 241, 0.14), transparent 60%),
      linear-gradient(180deg, rgba(12, 12, 16, 0.95), rgba(8, 8, 8, 0.95));
    padding: 1rem;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.04);
  }

  .state-map-svg {
    width: 100%;
    height: auto;
    display: block;
  }

  .state-path {
    fill: var(--map-unvisited);
    stroke: var(--map-stroke);
    stroke-width: 0.6;
    transition: fill 0.2s ease;
  }

  .state-path.is-visited {
    fill: var(--map-visited-soft);
    stroke: rgba(99, 102, 241, 0.2);
  }

  .state-path:hover {
    fill: var(--map-unvisited-hover);
  }

  .state-path.is-visited:hover {
    fill: var(--map-visited);
  }

  .state-map-label {
    position: absolute;
    padding: 0.4rem 0.6rem;
    border-radius: 999px;
    background: rgba(15, 15, 15, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--color-text);
    font-size: 0.75rem;
    letter-spacing: 0.02em;
    opacity: 0;
    transform: translate(-50%, -120%);
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 2;
  }

  .state-map-label.is-visible {
    opacity: 1;
    transform: translate(-50%, -135%);
  }

  @media (prefers-reduced-motion: reduce) {
    .progress-fill,
    .state-path,
    .state-map-label {
      transition: none;
    }
  }
</style>

<script is:inline>
  (function () {
    const map = document.querySelector('[data-us-state-map]');
    const label = map?.querySelector('[data-state-label]');
    const states = map?.querySelectorAll('[data-state]') || [];

    if (!map || !label) return;

    states.forEach((state) => {
      const name = state.getAttribute('data-name') || '';

      state.addEventListener('mouseenter', (e) => {
        label.textContent = name;
        label.classList.add('is-visible');
        const mapRect = map.getBoundingClientRect();
        label.style.left = `${e.clientX - mapRect.left}px`;
        label.style.top = `${e.clientY - mapRect.top}px`;
      });

      state.addEventListener('mousemove', (e) => {
        const mapRect = map.getBoundingClientRect();
        label.style.left = `${e.clientX - mapRect.left}px`;
        label.style.top = `${e.clientY - mapRect.top}px`;
      });

      state.addEventListener('mouseleave', () => {
        label.classList.remove('is-visible');
      });
    });
  })();
</script>
