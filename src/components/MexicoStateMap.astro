---
import travel from '../data/travel.json';
import { feature } from 'topojson-client';
import { geoMercator, geoPath } from 'd3-geo';
import mexicoTopo from '../data/mexico-states.json';

const NAME_CORRECTIONS: Record<string, string> = {
  'Distrito Federal': 'Ciudad de México',
  'Michoacán de Ocampo': 'Michoacán',
  'Veracruz de Ignacio de la Llave': 'Veracruz',
  'Coahuila de Zaragoza': 'Coahuila',
  'México': 'Estado de México',
};

const totalStates = 32;
const visitedCount = travel.mexicanStatesVisited.length;
const progressPercent = Math.round((visitedCount / totalStates) * 100);

const statesGeo = feature(mexicoTopo as any, (mexicoTopo as any).objects.states);
const width = 960;
const height = 560;
const projection = geoMercator().fitSize([width, height], statesGeo as any);
const path = geoPath(projection);

// INEGI codes in TopoJSON are numbers without leading zeros
const visitedInegi = new Set(
  travel.mexicanStatesVisited.map((s) => String(parseInt(s.inegi)))
);

// One city per state (32 total)
const majorCities = [
  { name: 'Aguascalientes', lat: 21.8853, lon: -102.2916 },
  { name: 'Tijuana', lat: 32.5149, lon: -117.0382 },
  { name: 'La Paz', lat: 24.1426, lon: -110.3128 },
  { name: 'Campeche', lat: 19.8301, lon: -90.5349 },
  { name: 'Tuxtla', lat: 16.7528, lon: -93.1152 },
  { name: 'Chihuahua', lat: 28.6353, lon: -106.0889 },
  { name: 'CDMX', lat: 19.4326, lon: -99.1332 },
  { name: 'Saltillo', lat: 25.4232, lon: -100.9924 },
  { name: 'Colima', lat: 19.2452, lon: -103.7241 },
  { name: 'Durango', lat: 24.0277, lon: -104.6532 },
  { name: 'Toluca', lat: 19.2826, lon: -99.6557 },
  { name: 'León', lat: 21.1221, lon: -101.6821 },
  { name: 'Acapulco', lat: 16.8531, lon: -99.8237 },
  { name: 'Pachuca', lat: 20.1011, lon: -98.7591 },
  { name: 'Guadalajara', lat: 20.6597, lon: -103.3496 },
  { name: 'Morelia', lat: 19.706, lon: -101.195 },
  { name: 'Cuernavaca', lat: 18.9242, lon: -99.2216 },
  { name: 'Tepic', lat: 21.5085, lon: -104.8953 },
  { name: 'Monterrey', lat: 25.6866, lon: -100.3161 },
  { name: 'Oaxaca', lat: 17.0732, lon: -96.7266 },
  { name: 'Puebla', lat: 19.0414, lon: -98.2063 },
  { name: 'Querétaro', lat: 20.5888, lon: -100.3899 },
  { name: 'Cancún', lat: 21.1619, lon: -86.8515 },
  { name: 'SLP', lat: 22.1565, lon: -100.9855 },
  { name: 'Culiacán', lat: 24.7994, lon: -107.394 },
  { name: 'Hermosillo', lat: 29.0729, lon: -110.9559 },
  { name: 'Villahermosa', lat: 17.9892, lon: -92.9475 },
  { name: 'Tampico', lat: 22.2331, lon: -97.8613 },
  { name: 'Tlaxcala', lat: 19.3139, lon: -98.2404 },
  { name: 'Veracruz', lat: 19.1738, lon: -96.1342 },
  { name: 'Mérida', lat: 20.9674, lon: -89.5926 },
  { name: 'Zacatecas', lat: 22.7709, lon: -102.5832 },
].map((city) => {
  const coords = projection([city.lon, city.lat]);
  if (!coords) return null;
  return { ...city, x: coords[0], y: coords[1] };
}).filter(Boolean);

const allStates = (statesGeo as any).features
  .map((geo: any) => {
    const code = String(geo.properties.state_code);
    const rawName = geo.properties.state_name as string;
    const name = NAME_CORRECTIONS[rawName] ?? rawName;
    return {
      inegi: code,
      name,
      visited: visitedInegi.has(code),
    };
  })
  .sort((a: any, b: any) => a.name.localeCompare(b.name));
---

<section class="card mx-state-map">
  <div class="flex flex-col gap-6">
    <div class="flex flex-col gap-2">
      <p class="text-sm uppercase tracking-[0.25em] text-text-muted">México</p>
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <h2 class="text-3xl md:text-4xl font-heading font-bold">Estados explored</h2>
        <div class="text-sm text-text-muted">
          {visitedCount} of {totalStates} states visited ({progressPercent}%)
        </div>
      </div>
      <div class="progress-track">
        <div class="progress-fill" style={`width: ${progressPercent}%;`}></div>
      </div>
    </div>

    <div class="state-map-shell" data-mx-state-map>
      <svg
        class="state-map-svg"
        viewBox={`0 0 ${width} ${height}`}
        preserveAspectRatio="xMidYMid meet"
        role="img"
        aria-label="Mexico map showing visited states"
      >
        <g class="state-map-paths">
          {(statesGeo as any).features.map((geo: any) => {
            const d = path(geo);
            if (!d) return null;
            const code = String(geo.properties.state_code);
            const rawName = geo.properties.state_name as string;
            const name = NAME_CORRECTIONS[rawName] ?? rawName;
            return (
              <path
                d={d}
                class:list={[
                  'state-path',
                  visitedInegi.has(code) && 'is-visited',
                ]}
                data-state={code}
                data-name={name}
              />
            );
          })}
        </g>
        <g class="city-markers">
          {majorCities.map((city: any) => (
            <g class="city-marker">
              <circle cx={city.x} cy={city.y} r="2.5" class="city-dot" />
              <text x={city.x} y={city.y - 7} class="city-label">{city.name}</text>
            </g>
          ))}
        </g>
      </svg>
      <div class="state-map-label" data-state-label aria-hidden="true"></div>
    </div>

    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-sm">
      {allStates.map((state: any) => (
        <div class:list={[
          'flex items-center gap-1.5 px-2 py-1.5 rounded-lg',
          state.visited ? 'text-text' : 'text-text-muted opacity-40',
        ]}>
          <span class:list={[
            'w-2 h-2 rounded-full flex-shrink-0',
          ]} style={state.visited ? 'background: var(--color-primary);' : 'background: var(--color-surface-hover);'}></span>
          <span class="truncate">{state.name}</span>
        </div>
      ))}
    </div>
  </div>
</section>

<style>
  .mx-state-map {
    --map-visited: var(--color-primary);
    --map-visited-soft: rgba(99, 102, 241, 0.55);
    --map-unvisited: #171717;
    --map-unvisited-hover: #202020;
    --map-stroke: rgba(255, 255, 255, 0.06);
  }

  .progress-track {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: var(--color-surface-hover);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    border-radius: 999px;
    background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
    transition: width 0.6s ease;
  }

  .state-map-shell {
    position: relative;
    border-radius: 16px;
    background:
      radial-gradient(circle at top, rgba(99, 102, 241, 0.14), transparent 60%),
      linear-gradient(180deg, rgba(12, 12, 16, 0.95), rgba(8, 8, 8, 0.95));
    padding: 1rem;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.04);
  }

  .state-map-svg {
    width: 100%;
    height: auto;
    display: block;
  }

  .state-path {
    fill: var(--map-unvisited);
    stroke: var(--map-stroke);
    stroke-width: 0.6;
    transition: fill 0.2s ease;
  }

  .state-path.is-visited {
    fill: var(--map-visited-soft);
    stroke: rgba(99, 102, 241, 0.2);
  }

  .city-dot {
    fill: rgba(255, 255, 255, 0.5);
  }

  .city-label {
    fill: rgba(255, 255, 255, 0.4);
    font-size: 7.5px;
    text-anchor: middle;
    pointer-events: none;
    font-family: var(--font-body, sans-serif);
  }

  .state-path:hover {
    fill: var(--map-unvisited-hover);
  }

  .state-path.is-visited:hover {
    fill: var(--map-visited);
  }

  .state-map-label {
    position: absolute;
    padding: 0.4rem 0.6rem;
    border-radius: 999px;
    background: rgba(15, 15, 15, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--color-text);
    font-size: 0.75rem;
    letter-spacing: 0.02em;
    opacity: 0;
    transform: translate(-50%, -120%);
    pointer-events: none;
    transition: opacity 0.15s ease, transform 0.15s ease;
    z-index: 2;
  }

  .state-map-label.is-visible {
    opacity: 1;
    transform: translate(-50%, -135%);
  }

  @media (prefers-reduced-motion: reduce) {
    .progress-fill,
    .state-path,
    .state-map-label {
      transition: none;
    }
  }
</style>

<script is:inline>
  (function () {
    const map = document.querySelector('[data-mx-state-map]');
    const label = map?.querySelector('[data-state-label]');
    const states = map?.querySelectorAll('[data-state]') || [];

    if (!map || !label) return;

    states.forEach((state) => {
      const name = state.getAttribute('data-name') || '';

      state.addEventListener('mouseenter', (e) => {
        label.textContent = name;
        label.classList.add('is-visible');
        const mapRect = map.getBoundingClientRect();
        label.style.left = `${e.clientX - mapRect.left}px`;
        label.style.top = `${e.clientY - mapRect.top}px`;
      });

      state.addEventListener('mousemove', (e) => {
        const mapRect = map.getBoundingClientRect();
        label.style.left = `${e.clientX - mapRect.left}px`;
        label.style.top = `${e.clientY - mapRect.top}px`;
      });

      state.addEventListener('mouseleave', () => {
        label.classList.remove('is-visible');
      });
    });
  })();
</script>
