---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import MediaCard from "../../components/library/MediaCard.astro";
import TierBadge from "../../components/library/TierBadge.astro";

const items = await getCollection("library");

// Sort: S+ first, then by Date (Newest)
const sortedItems = items.sort((a, b) => {
    const tiers = ["S+", "S", "A", "B", "C", "D"];
    const tierDiff = tiers.indexOf(a.data.tier) - tiers.indexOf(b.data.tier);
    if (tierDiff !== 0) return tierDiff;
    return (
        new Date(b.data.dateRead).getTime() -
        new Date(a.data.dateRead).getTime()
    );
});

// Categories for filter
const categories = [...new Set(items.flatMap((i) => i.data.categories))].sort();

// Pre-calculate stats for all types
const stats = {
    book: {
        total: items.filter((i) => i.data.type === "book").length,
        legendary: items.filter(
            (i) => i.data.type === "book" && i.data.tier === "S+",
        ).length,
        sTier: items.filter(
            (i) => i.data.type === "book" && i.data.tier === "S",
        ).length,
        thisYear: items.filter(
            (i) =>
                i.data.type === "book" &&
                i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
    },
    podcast: {
        total: items.filter((i) => i.data.type === "podcast").length,
        legendary: items.filter(
            (i) => i.data.type === "podcast" && i.data.tier === "S+",
        ).length,
        sTier: items.filter(
            (i) => i.data.type === "podcast" && i.data.tier === "S",
        ).length,
        thisYear: items.filter(
            (i) =>
                i.data.type === "podcast" &&
                i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
    },
    video: {
        total: items.filter((i) => i.data.type === "video").length,
        legendary: items.filter(
            (i) => i.data.type === "video" && i.data.tier === "S+",
        ).length,
        sTier: items.filter(
            (i) => i.data.type === "video" && i.data.tier === "S",
        ).length,
        thisYear: items.filter(
            (i) =>
                i.data.type === "video" &&
                i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
    },
    article: {
        total: items.filter((i) => i.data.type === "article").length,
        legendary: items.filter(
            (i) => i.data.type === "article" && i.data.tier === "S+",
        ).length,
        sTier: items.filter(
            (i) => i.data.type === "article" && i.data.tier === "S",
        ).length,
        thisYear: items.filter(
            (i) =>
                i.data.type === "article" &&
                i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
    },
    music: {
        total: items.filter((i) => i.data.type === "music").length,
        legendary: items.filter(
            (i) => i.data.type === "music" && i.data.tier === "S+",
        ).length,
        sTier: items.filter(
            (i) => i.data.type === "music" && i.data.tier === "S",
        ).length,
        thisYear: items.filter(
            (i) =>
                i.data.type === "music" &&
                i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
    },
    all: {
        total: items.length,
        legendary: items.filter((i) => i.data.tier === "S+").length,
        thisYear: items.filter((i) =>
            i.data.dateRead.includes(new Date().getFullYear().toString()),
        ).length,
        // sTier across all? User asked for: "Total Items, S-Tier Across All, Added This Year"
    },
};

const libraryJsonLd = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "Library",
    "url": "https://jacksquire.com/library",
    "hasPart": items.map((item) => ({
        "@type": "CreativeWork",
        "name": item.data.title,
        "url": `https://jacksquire.com/library/${item.slug || item.id}`,
    })),
};
---

<BaseLayout title="Library | Jack Squire" description="My multi-media diet.">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 md:pt-32 pb-12">
        <!-- Header & Tabs -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-zinc-100 mb-6">Library</h1>
            <p class="text-zinc-400 max-w-2xl mb-6">
                A collection of my favorite things, from books to music to podcasts.
            </p>

            <!-- Type Tabs -->
            <div
                class="border-b border-zinc-800 mb-8 overflow-x-auto no-scrollbar"
            >
                <div class="flex space-x-8" id="type-tabs">
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="all">All</button
                    >
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="book">Books</button
                    >
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="podcast">Podcasts</button
                    >
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="video">Videos</button
                    >
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="article">Articles</button
                    >
                    <button
                        class="tab-btn pb-3 text-sm font-medium border-b-2 border-transparent text-zinc-400 hover:text-zinc-200 whitespace-nowrap"
                        data-tab="music">Music</button
                    >
                </div>
            </div>

            <!-- Stats Area -->
            <div
                class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"
                id="stats-container"
                aria-live="polite"
                aria-atomic="true"
            >
                <!-- Dynamic Content filled by JS -->
                <div
                    class="stat-card bg-zinc-900 border border-zinc-800 p-4 rounded-lg"
                >
                    <p class="text-zinc-500 text-sm" id="stat-label-1">
                        Logged
                    </p>
                    <p
                        class="text-3xl font-mono font-bold text-zinc-100"
                        id="stat-val-1"
                    >
                        -
                    </p>
                </div>
                <div
                    class="stat-card bg-zinc-900 border border-zinc-800 p-4 rounded-lg"
                >
                    <p class="text-yellow-500/80 text-sm">Legendary (S+)</p>
                    <p
                        class="text-3xl font-mono font-bold text-yellow-400"
                        id="stat-val-2"
                    >
                        -
                    </p>
                </div>
                <div
                    class="stat-card bg-zinc-900 border border-zinc-800 p-4 rounded-lg"
                >
                    <p class="text-zinc-500 text-sm">S Tier</p>
                    <p
                        class="text-3xl font-mono font-bold text-zinc-100"
                        id="stat-val-3"
                    >
                        -
                    </p>
                </div>
                <div
                    class="stat-card bg-zinc-900 border border-zinc-800 p-4 rounded-lg"
                >
                    <p class="text-zinc-500 text-sm">This Year</p>
                    <p
                        class="text-3xl font-mono font-bold text-zinc-100"
                        id="stat-val-4"
                    >
                        -
                    </p>
                </div>
            </div>

        </div>

        <!-- Filters -->
        <div
            class="library-filters mb-8 p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl space-y-4"
            id="filter-container"
            data-filter-container
        >
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1 relative">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search..."
                        class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-4 py-2 text-zinc-200 focus:outline-none focus:border-blue-500/50"
                    />
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-[0.2em] text-zinc-500">Tier</div>
                <div class="flex flex-wrap gap-2" id="tier-chips">
                    <button class="chip chip-active" data-tier="">
                        All
                    </button>
                    <button class="chip" data-tier="S+">S+ Legendary</button>
                    <button class="chip" data-tier="S">S Masterpiece</button>
                    <button class="chip" data-tier="A">A Excellent</button>
                    <button class="chip" data-tier="B">B Good</button>
                    <button class="chip" data-tier="C">C Fine</button>
                    <button class="chip" data-tier="D">D Avoid</button>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <div class="text-xs uppercase tracking-[0.2em] text-zinc-500">Tags</div>
                <div class="flex flex-wrap gap-2" id="category-chips">
                    <button class="chip chip-active" data-category="">
                        All
                    </button>
                    {categories.map((c) => (
                        <button class="chip" data-category={c}>
                            {c}
                        </button>
                    ))}
                </div>
            </div>

            <div id="active-filters" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Grid -->
        <div
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 gap-y-10 content-visibility-auto"
            id="media-grid"
        >
            {
                sortedItems.map((item) => (
                    <div
                        class="media-item"
                        data-type={item.data.type}
                        data-tier={item.data.tier}
                        data-title={item.data.title.toLowerCase()}
                        data-categories={item.data.categories
                            .join(",")
                            .toLowerCase()}
                        data-search={`${item.data.title} ${item.data.hotTake}`.toLowerCase()}
                    >
                        <MediaCard item={item} />
                    </div>
                ))
            }
        </div>

        <div
            id="empty-state"
            class="hidden mt-12 text-center text-zinc-400 border border-zinc-800 rounded-xl p-8 bg-zinc-900/40"
        >
            <p class="text-lg font-semibold text-zinc-200 mb-2">No results</p>
            <p>Try clearing a filter or searching for something else.</p>
        </div>
    </div>
</BaseLayout>

<script type="application/ld+json">
    {JSON.stringify(libraryJsonLd)}
</script>

<script define:vars={{ stats }}>
    // State
    let activeTab = "all"; // Default

    // Elements
    const tabs = document.querySelectorAll(".tab-btn");
    const items = document.querySelectorAll(".media-item");
    const statVal1 = document.getElementById("stat-val-1");
    const statVal2 = document.getElementById("stat-val-2");
    const statVal3 = document.getElementById("stat-val-3");
    const statVal4 = document.getElementById("stat-val-4");
    const statLabel1 = document.getElementById("stat-label-1");

    const searchInput = document.getElementById("search-input");
    const tierFilter = { value: "" };
    const categoryFilter = { value: "" };
    const quickTierButtons = document.querySelectorAll(".tier-quick");
    let quickTierMode = "";
    const tierChips = document.querySelectorAll("#tier-chips .chip");
    const categoryChips = document.querySelectorAll("#category-chips .chip");
    const activeFilters = document.getElementById("active-filters");
    const emptyState = document.getElementById("empty-state");
    const filterContainer = document.querySelector("[data-filter-container]");
    const cardLinks = document.querySelectorAll(".media-item a");

    cardLinks.forEach((link) => {
        if (!link.dataset.baseHref) {
            link.dataset.baseHref = link.getAttribute("href") || "";
        }
    });

    function updateActiveTabURI(tab) {
        const url = new URL(window.location);
        url.searchParams.set("tab", tab);
        window.history.replaceState({}, "", url);
    }

    function updateQueryParams() {
        const url = new URL(window.location);
        url.searchParams.set("tab", activeTab);
        if (searchInput.value) {
            url.searchParams.set("q", searchInput.value);
        } else {
            url.searchParams.delete("q");
        }
        if (tierFilter.value) {
            url.searchParams.set("tier", tierFilter.value);
        } else {
            url.searchParams.delete("tier");
        }
        if (categoryFilter.value) {
            url.searchParams.set("tag", categoryFilter.value);
        } else {
            url.searchParams.delete("tag");
        }
        window.history.replaceState({}, "", url);
    }

    function updateCardLinks() {
        const params = new URLSearchParams();
        params.set("tab", activeTab);
        if (searchInput.value) params.set("q", searchInput.value);
        if (tierFilter.value) params.set("tier", tierFilter.value);
        if (categoryFilter.value) params.set("tag", categoryFilter.value);

        const query = params.toString();
        cardLinks.forEach((link) => {
            const base = link.dataset.baseHref || link.getAttribute("href") || "";
            link.setAttribute("href", query ? `${base}?${query}` : base);
        });
    }

    function renderStats() {
        const data = stats[activeTab];
        const labels = {
            book: "Books Logged",
            podcast: "Episodes Logged",
            video: "Videos Logged",
            article: "Articles Logged",
            music: "Music Logged",
            all: "Total Items",
        };

        statLabel1.innerText = labels[activeTab];
        statVal1.innerText = data.total;
        statVal2.innerText = data.legendary;
        statVal3.innerText = activeTab === "all" ? "-" : data.sTier;
        statVal4.innerText = data.thisYear;
    }

    function renderActiveFilters() {
        if (!activeFilters) return;
        const pills = [];

        if (activeTab && activeTab !== "all") {
            pills.push({ label: `Type: ${activeTab}`, action: () => setTab("all") });
        }
        if (searchInput.value) {
            pills.push({ label: `Search: ${searchInput.value}`, action: () => {
                searchInput.value = "";
                filterItems();
            }});
        }
        if (tierFilter.value) {
            pills.push({ label: `Tier: ${tierFilter.value}`, action: () => {
                tierFilter.value = "";
                tierChips.forEach((c) => c.classList.remove("chip-active"));
                tierChips.forEach((c) => {
                    if (c.dataset.tier === "") c.classList.add("chip-active");
                });
                filterItems();
            }});
        }
        if (categoryFilter.value) {
            pills.push({ label: `Tag: ${categoryFilter.value}`, action: () => {
                categoryFilter.value = "";
                categoryChips.forEach((c) => c.classList.remove("chip-active"));
                categoryChips.forEach((c) => {
                    if (c.dataset.category === "") c.classList.add("chip-active");
                });
                filterItems();
            }});
        }

        activeFilters.innerHTML = "";
        pills.forEach((pill) => {
            const btn = document.createElement("button");
            btn.className = "chip chip-active";
            btn.textContent = `Ã— ${pill.label}`;
            btn.addEventListener("click", pill.action);
            activeFilters.appendChild(btn);
        });
    }

    function filterItems() {
        const query = searchInput.value.toLowerCase();
        const tier = tierFilter.value;
        const cat = categoryFilter.value.toLowerCase();
        let visibleCount = 0;

        items.forEach((el) => {
            const type = el.dataset.type;
            const matchesTab = activeTab === "all" || type === activeTab;

            const matchesSearch = !query || el.dataset.search.includes(query);
            let matchesTier = !tier || el.dataset.tier === tier;
            if (quickTierMode === "s-plus") {
                matchesTier = el.dataset.tier === "S+";
            }
            if (quickTierMode === "s-plus-and-s") {
                matchesTier = el.dataset.tier === "S+" || el.dataset.tier === "S";
            }
            const matchesCat = !cat || el.dataset.categories.includes(cat);

            if (matchesTab && matchesSearch && matchesTier && matchesCat) {
                el.style.display = "block";
                visibleCount += 1;
            } else {
                el.style.display = "none";
            }
        });

        if (emptyState) {
            emptyState.classList.toggle("hidden", visibleCount > 0);
        }
        renderActiveFilters();
        updateQueryParams();
        updateCardLinks();
    }

    function setTab(tab) {
        activeTab = tab;

        // UI State
        tabs.forEach((t) => {
            if (t.dataset.tab === tab) {
                t.classList.remove("border-transparent", "text-zinc-400");
                t.classList.add("border-blue-500", "text-blue-400");
            } else {
                t.classList.add("border-transparent", "text-zinc-400");
                t.classList.remove("border-blue-500", "text-blue-400");
            }
        });

        renderStats();
        filterItems();
        updateActiveTabURI(tab);
    }

    // Init
    const params = new URLSearchParams(window.location.search);
    const initialTab = params.get("tab") || "all";
    const initialQuery = params.get("q") || "";
    const initialTier = params.get("tier") || "";
    const initialTag = params.get("tag") || "";
    setTab(initialTab);
    if (initialQuery) {
        searchInput.value = initialQuery;
    }
    if (initialTier) {
        tierFilter.value = initialTier;
        tierChips.forEach((c) => c.classList.remove("chip-active"));
        tierChips.forEach((c) => {
            if (c.dataset.tier === initialTier) c.classList.add("chip-active");
        });
    }
    if (initialTag) {
        categoryFilter.value = initialTag;
        categoryChips.forEach((c) => c.classList.remove("chip-active"));
        categoryChips.forEach((c) => {
            if (c.dataset.category === initialTag) c.classList.add("chip-active");
        });
    }
    filterItems();

    // Listeners
    tabs.forEach((btn) =>
        btn.addEventListener("click", () => setTab(btn.dataset.tab)),
    );
    searchInput.addEventListener("input", filterItems);

    tierChips.forEach((chip) => {
        chip.addEventListener("click", () => {
            tierChips.forEach((c) => c.classList.remove("chip-active"));
            chip.classList.add("chip-active");
            tierFilter.value = chip.dataset.tier || "";
            quickTierMode = "";
            filterItems();
        });
    });

    categoryChips.forEach((chip) => {
        chip.addEventListener("click", () => {
            categoryChips.forEach((c) => c.classList.remove("chip-active"));
            chip.classList.add("chip-active");
            categoryFilter.value = chip.dataset.category || "";
            filterItems();
        });
    });

    quickTierButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const mode = btn.dataset.tierQuick;
            quickTierMode = mode === "clear" ? "" : mode;
            if (mode === "s-plus") {
                tierFilter.value = "S+";
                tierChips.forEach((c) => c.classList.remove("chip-active"));
                tierChips.forEach((c) => {
                    if (c.dataset.tier === "S+") c.classList.add("chip-active");
                });
                quickTierMode = "s-plus";
            } else if (mode === "s-plus-and-s") {
                tierFilter.value = "";
                tierChips.forEach((c) => c.classList.remove("chip-active"));
                tierChips.forEach((c) => {
                    if (c.dataset.tier === "") c.classList.add("chip-active");
                });
                quickTierMode = "s-plus-and-s";
            } else {
                tierFilter.value = "";
                tierChips.forEach((c) => c.classList.remove("chip-active"));
                tierChips.forEach((c) => {
                    if (c.dataset.tier === "") c.classList.add("chip-active");
                });
            }
            filterItems();
        });
    });

    const onScroll = () => {
        if (!filterContainer) return;
        filterContainer.classList.toggle("is-sticky", window.scrollY > 240);
    };

    window.addEventListener("scroll", onScroll, { passive: true });
    onScroll();
</script>

<style>
    .library-filters.is-sticky {
        position: sticky;
        top: 76px;
        z-index: 30;
        backdrop-filter: blur(10px);
    }

    .library-filters.is-sticky .chip {
        font-size: 0.8rem;
    }

    .library-filters.is-sticky input {
        padding-top: 0.35rem;
        padding-bottom: 0.35rem;
    }

    .chip {
        border: 1px solid #27272a;
        color: #a1a1aa;
        font-size: 0.85rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
        background: rgba(9, 9, 11, 0.6);
    }

    .chip:hover {
        border-color: #3f3f46;
        color: #f4f4f5;
    }

    .chip-active {
        border-color: #3b82f6;
        color: #eff6ff;
        background: rgba(59, 130, 246, 0.15);
    }
</style>
