---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import TierBadge from "../../components/library/TierBadge.astro";

export async function getStaticPaths() {
    const items = await getCollection("library");
    return items.map((item) => ({
        params: { slug: item.slug || item.id },
        props: { item },
    }));
}

interface Props {
    item: CollectionEntry<"library">;
}

const { item } = Astro.props;
const { Content } = await item.render();
const {
    title,
    coverImage,
    tier,
    dateRead,
    hotTake,
    keyTakeaways,
    recommendTo,
    categories,
    type,
    longerThoughts, // unused in destructuring but available
} = item.data; // Common fields

// Type guards / Helper extraction
const isBook = type === "book";
const isPodcast = type === "podcast";
const isVideo = type === "video";
const isArticle = type === "article";
const isMusic = type === "music";

// Safe data extraction with type narrowing
let author = "";
let subtitle = "";
let contextLink = "";
let contextLabel = "";
let contextColor = "";
let icon = "‚ú®";

if (item.data.type === "book") {
    author = item.data.author || "";
    subtitle = `by ${author}`;
    contextLink = item.data.amazonLink || "";
    contextLabel = "Buy on Amazon";
    contextColor = "bg-yellow-600 hover:bg-yellow-500";
    icon = "üìö";
} else if (item.data.type === "podcast") {
    author = item.data.host || "";
    subtitle = `Host: ${author}`;
    contextLink = item.data.appleLink || item.data.spotifyLink || "";
    contextLabel = "Listen";
    contextColor = "bg-purple-600 hover:bg-purple-500";
    icon = "üéôÔ∏è";
} else if (item.data.type === "video") {
    author = item.data.channel || "";
    subtitle = `Channel: ${author}`;
    contextLink = `https://youtube.com/watch?v=${item.data.videoId}`;
    contextLabel = "Watch on YouTube";
    contextColor = "bg-red-600 hover:bg-red-500";
    icon = "üé¨";
} else if (item.data.type === "article") {
    author = item.data.author || "";
    subtitle = `by ${author}`;
    contextLink = item.data.link;
    contextLabel = "Read Article";
    contextColor = "bg-blue-600 hover:bg-blue-500";
    icon = "üìù";
} else if (item.data.type === "music") {
    author = item.data.artist || "";
    subtitle = `${item.data.kind} ‚Ä¢ ${item.data.platform}`;
    contextLink = item.data.link;
    contextLabel = "Open Link";
    contextColor = "bg-emerald-600 hover:bg-emerald-500";
    icon = "üéß";
}
---

<BaseLayout title={`${title} | Library`} description={`My review of ${title}`}>
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 pt-28 md:pt-32 pb-12">
        <div class="sticky top-16 z-20 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-3 bg-background/80 backdrop-blur border-b border-border/60">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <button
                    type="button"
                    class="btn btn-secondary text-sm"
                    data-back-link
                >
                    ‚Üê Back to results
                </button>
                <div class="text-xs uppercase tracking-[0.2em] text-text-muted">
                    <span id="back-meta">Library</span> / <span class="text-text">{title}</span>
                </div>
            </div>
        </div>

        <div class="grid md:grid-cols-[300px_1fr] gap-8 md:gap-12">
            <!-- Left: Cover & Meta -->
            <div class="space-y-6">
                <div
                    class="aspect-[2/3] relative rounded-lg overflow-hidden shadow-2xl bg-zinc-900 border border-zinc-800"
                >
                    {
                        coverImage ? (
                            <img
                                src={coverImage}
                                alt={title}
                                class="w-full h-full object-cover"
                            />
                        ) : (
                            <div class="w-full h-full flex items-center justify-center text-5xl text-zinc-700">
                                {icon}
                            </div>
                        )
                    }
                </div>

                <div class="flex flex-col gap-3">
                    {
                        contextLink && (
                            <a
                                href={contextLink}
                                target="_blank"
                                rel="noopener noreferrer"
                                class={`block w-full text-center py-2 px-4 text-white font-bold rounded-lg transition-colors ${contextColor}`}
                            >
                                {contextLabel}
                            </a>
                        )
                    }

                    <div
                        class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 space-y-3 text-sm text-zinc-400"
                    >
                        <div class="flex justify-between">
                            <span>Consumed</span>
                            <span class="text-zinc-200">{dateRead}</span>
                        </div>

                        {/* Type Specific Stats */}
                        {
                            item.data.type === "book" && (
                                <>
                                    <div class="flex justify-between">
                                        <span>Published</span>
                                        <span class="text-zinc-200">
                                            {item.data.publishedYear}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Pages</span>
                                        <span class="text-zinc-200">
                                            {item.data.pageCount}
                                        </span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>Readability</span>
                                        <span class="px-2 py-0.5 rounded bg-zinc-800 text-xs">
                                            {item.data.readability}
                                        </span>
                                    </div>
                                </>
                            )
                        }

                        {
                            item.data.type === "podcast" && (
                                <>
                                    <div class="flex justify-between">
                                        <span>Podcast</span>
                                        <span class="text-zinc-200 text-right truncate w-32">
                                            {item.data.podcastName}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Duration</span>
                                        <span class="text-zinc-200">
                                            {item.data.duration}
                                        </span>
                                    </div>
                                </>
                            )
                        }

                        {
                            item.data.type === "video" && (
                                <div class="flex justify-between">
                                    <span>Duration</span>
                                    <span class="text-zinc-200">
                                        {item.data.duration}m
                                    </span>
                                </div>
                            )
                        }

                        {
                            item.data.type === "article" && (
                                <>
                                    <div class="flex justify-between">
                                        <span>Publication</span>
                                        <span class="text-zinc-200">
                                            {item.data.publication}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Word Count</span>
                                        <span class="text-zinc-200">
                                            {item.data.wordCount}
                                        </span>
                                    </div>
                                </>
                            )
                        }

                        {
                            item.data.type === "music" && (
                                <>
                                    <div class="flex justify-between">
                                        <span>Artist</span>
                                        <span class="text-zinc-200">
                                            {item.data.artist}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Type</span>
                                        <span class="text-zinc-200">
                                            {item.data.kind}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Platform</span>
                                        <span class="text-zinc-200">
                                            {item.data.platform}
                                        </span>
                                    </div>
                                    {item.data.duration && (
                                        <div class="flex justify-between">
                                            <span>Duration</span>
                                            <span class="text-zinc-200">
                                                {item.data.duration}
                                            </span>
                                        </div>
                                    )}
                                    {item.data.mood && (
                                        <div class="flex justify-between">
                                            <span>Mood</span>
                                            <span class="text-zinc-200">
                                                {item.data.mood}
                                            </span>
                                        </div>
                                    )}
                                </>
                            )
                        }

                        <hr class="border-zinc-800" />

                        <div class="flex justify-between items-center">
                            <span>Type</span>
                            <span
                                class="uppercase text-xs tracking-wider bg-zinc-800 px-2 py-0.5 rounded"
                                >{type}</span
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Content -->
            <div class="space-y-8">
                <div>
                    <div class="flex items-start justify-between gap-4 mb-2">
                        <h1
                            class="text-4xl font-bold text-zinc-100 leading-tight"
                        >
                            {title}
                        </h1>
                        <div class="flex items-center gap-3">
                            {contextLink && (
                                <a
                                    href={contextLink}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="btn btn-secondary text-sm"
                                >
                                    Open link
                                </a>
                            )}
                            <TierBadge tier={tier} size="lg" />
                        </div>
                    </div>
                    <p class="text-xl text-zinc-400 font-serif italic mb-6">
                        {subtitle}
                    </p>

                    <div
                        class="bg-zinc-900/50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-8"
                    >
                        <h3
                            class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-1"
                        >
                            Hot Take
                        </h3>
                        <p class="text-zinc-200 italic font-serif text-lg">
                            "{hotTake}"
                        </p>
                    </div>

                    {
                        keyTakeaways && keyTakeaways.length > 0 && (
                            <div class="mb-8">
                                <h3 class="text-zinc-100 font-bold mb-4 flex items-center gap-2">
                                    <span class="text-yellow-500">üí°</span> Key
                                    Takeaways
                                </h3>
                                <ul class="space-y-2">
                                    {keyTakeaways.map((t) => (
                                        <li class="flex gap-3 text-zinc-300">
                                            <span class="text-zinc-600 mt-1.5">
                                                ‚Ä¢
                                            </span>
                                            <span>{t}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )
                    }

                    {
                        item.data.type === "video" && item.data.videoId && (
                            <div class="mb-8 aspect-video rounded-lg overflow-hidden border border-zinc-800 shadow-lg">
                                <iframe
                                    width="100%"
                                    height="100%"
                                    src={`https://www.youtube.com/embed/${item.data.videoId}`}
                                    title="YouTube video player"
                                    frameborder="0"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                    allowfullscreen
                                />
                            </div>
                        )
                    }

                    {
                        item.data.type === "music" &&
                            item.data.platform === "YouTube" && (
                                <div class="mb-8 aspect-video rounded-lg overflow-hidden border border-zinc-800 shadow-lg">
                                    <iframe
                                        width="100%"
                                        height="100%"
                                        src={
                                            item.data.playlistId
                                                ? `https://www.youtube.com/embed/${item.data.youtubeId}?list=${item.data.playlistId}`
                                                : `https://www.youtube.com/embed/${item.data.youtubeId}`
                                        }
                                        title="YouTube player"
                                        frameborder="0"
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                        allowfullscreen
                                    />
                                </div>
                            )
                    }

                    <div class="prose prose-invert prose-zinc max-w-none">
                        <h3 class="text-zinc-100 font-bold text-lg mb-4">
                            Longer Thoughts
                        </h3>
                        <Content />
                    </div>
                </div>

                {
                    recommendTo && recommendTo.length > 0 && (
                        <div class="pt-8 border-t border-zinc-800">
                            <p class="text-sm text-zinc-500 mb-2">
                                Recommended for:
                            </p>
                            <div class="flex flex-wrap gap-2">
                                {recommendTo.map((r) => (
                                    <span class="px-3 py-1 rounded-full bg-zinc-800 text-zinc-300 text-sm border border-zinc-700">
                                        {r}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )
                }
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    const backButton = document.querySelector('[data-back-link]');
    const backMeta = document.getElementById('back-meta');
    const params = new URLSearchParams(window.location.search);
    const tab = params.get('tab');
    const tier = params.get('tier');
    const tag = params.get('tag');
    const query = params.get('q');
    const parts = [];

    if (tab && tab !== 'all') {
        parts.push(tab.charAt(0).toUpperCase() + tab.slice(1));
    } else {
        parts.push('All');
    }
    if (tier) parts.push(`Tier ${tier}`);
    if (tag) parts.push(tag);
    if (query) parts.push(`"${query}"`);

    if (backMeta) {
        backMeta.textContent = parts.length ? `Results: ${parts.join(' ‚Ä¢ ')}` : 'Library';
    }

    const fallbackUrl = params.toString() ? `/library?${params.toString()}` : '/library';
    backButton?.addEventListener('click', () => {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.location.href = fallbackUrl;
        }
    });
</script>
