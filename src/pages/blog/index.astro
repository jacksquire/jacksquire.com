---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

// Get all blog posts, filter out drafts, sort by date
const posts = (await getCollection('blog'))
  .filter(post => !post.data.draft && !post.slug.startsWith('_'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract unique categories
const categories = ['All', ...new Set(posts.map(post => post.data.category))];

// Calculate reading time
function getReadingTime(content: string): string {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  const minutes = Math.ceil(words / wordsPerMinute);
  return `${minutes} min read`;
}

const blogJsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": "Blog",
  "url": "https://jacksquire.com/blog",
  "hasPart": posts.map((post) => ({
    "@type": "BlogPosting",
    "headline": post.data.title,
    "url": `https://jacksquire.com/blog/${post.slug}`,
  })),
};
---

<BaseLayout
  title="Blog"
  description="Thoughts on building products, entrepreneurship, and the journey of turning ideas into reality."
>
  <section class="section pt-32 md:pt-40">
    <div class="container">
      <!-- Header -->
      <div class="max-w-2xl mb-12">
        <h1 class="text-4xl md:text-5xl font-heading font-bold mb-6">
          Blog
        </h1>
        <p class="text-xl text-text-muted leading-relaxed">
          Thoughts on building products, entrepreneurship, and the journey
          of turning ideas into reality. I write to learn and share what I discover.
        </p>
      </div>

      <!-- Category Filter -->
      <div class="flex flex-wrap gap-2 mb-12">
        {categories.map((category, index) => (
          <button
            class:list={[
              'px-4 py-2 rounded-full text-sm font-medium transition-all category-btn',
              index === 0
                ? 'bg-primary text-white'
                : 'bg-surface border border-border text-text-muted hover:text-text hover:border-primary'
            ]}
            data-category={category}
          >
            {category}
          </button>
        ))}
      </div>

      <!-- Posts Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 content-visibility-auto" id="posts-grid">
        {posts.map((post) => (
          <article class="post-card" data-category={post.data.category}>
            <BlogCard
              title={post.data.title}
              excerpt={post.data.description}
              slug={post.slug}
              date={post.data.date.toISOString()}
              category={post.data.category}
              readingTime={getReadingTime(post.body)}
              image={post.data.image}
            />
          </article>
        ))}
      </div>

      {posts.length === 0 && (
        <div class="text-center py-12">
          <p class="text-text-muted">No posts yet. Check back soon!</p>
        </div>
      )}

      <!-- Newsletter CTA -->
      <div class="mt-20 gradient-border p-8 md:p-12 text-center">
        <h2 class="text-2xl md:text-3xl font-heading font-bold mb-4">
          Stay Updated
        </h2>
        <p class="text-text-muted max-w-xl mx-auto mb-6">
          Get new posts delivered to your inbox. No spam, unsubscribe anytime.
        </p>
        <form class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
          <input
            type="email"
            placeholder="your@email.com"
            class="flex-grow px-4 py-3 rounded-lg bg-surface border border-border text-text placeholder:text-text-muted focus:outline-none focus:border-primary transition-colors"
            required
          />
          <button type="submit" class="btn btn-primary whitespace-nowrap">
            Subscribe
          </button>
        </form>
      </div>
    </div>
  </section>
</BaseLayout>

<script type="application/ld+json">
  {JSON.stringify(blogJsonLd)}
</script>

<script>
  const categoryButtons = document.querySelectorAll('.category-btn');
  const postCards = document.querySelectorAll('.post-card');

  categoryButtons.forEach(button => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');

      // Update active state
      categoryButtons.forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white');
        btn.classList.add('bg-surface', 'text-text-muted');
      });
      button.classList.remove('bg-surface', 'text-text-muted');
      button.classList.add('bg-primary', 'text-white');

      // Filter posts
      postCards.forEach(card => {
        const postCategory = card.getAttribute('data-category');
        if (category === 'All' || postCategory === category) {
          (card as HTMLElement).style.display = 'block';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>
