---
import BaseLayout from '../layouts/BaseLayout.astro';
import TravelMap from '../components/TravelMap.astro';
import USStateMap from '../components/USStateMap.astro';
import MexicoStateMap from '../components/MexicoStateMap.astro';
import TripLogTimeline from '../components/TripLogTimeline.astro';
import travel from '../data/travel.json';
import { feature } from 'topojson-client';
import countries from 'world-atlas/countries-110m.json';
import isoCountries from 'i18n-iso-countries';
import enLocale from 'i18n-iso-countries/langs/en.json';

isoCountries.registerLocale(enLocale);

const world = feature(countries, countries.objects.countries);
const allCountries = world.features
  .map((geo) => {
    const id = Number(geo.id);
    const code = isoCountries.numericToAlpha2(id);
    const name = code ? isoCountries.getName(code, 'en') : null;
    return {
      id,
      code,
      name: name || geo.properties?.name || null,
    };
  })
  .filter((country) => country.code && country.name)
  .sort((a, b) => a.name.localeCompare(b.name));

const visitedCodes = new Set(travel.countriesVisited.map((country) => country.code));
const visitedCountries = travel.countriesVisited
  .map((country) => country.name)
  .sort((a, b) => a.localeCompare(b));
const notVisitedCountries = allCountries
  .filter((country) => !visitedCodes.has(country.code))
  .map((country) => country.name)
  .sort((a, b) => a.localeCompare(b));

const livedTimeline = travel.citiesLived;
---

<BaseLayout
  title="Travels"
  description="A personal map of Jack Squire's journey from hometown to digital nomad to intentionally rooted in Mexico City."
>
  <section class="section pt-32 md:pt-40">
    <div class="container max-w-6xl">
      <div class="mb-10 md:mb-14">
        <p class="text-sm uppercase tracking-[0.3em] text-text-muted mb-4">Travel Story</p>
        <h1 class="text-4xl md:text-5xl font-heading font-bold mb-4">The map behind the story</h1>
        <p class="text-lg text-text-muted max-w-2xl">
          A simple snapshot of the journey so far. San Diego to the nomad years, now rooted in Mexico City.
        </p>
      </div>

      <TravelMap />
      <p class="text-sm text-text-muted mt-4 md:hidden">
        Tip: pinch to zoom, drag to pan, tap pins for the story.
      </p>

      <div class="mt-12 grid gap-6 md:grid-cols-3 text-sm text-text-muted">
        <div class="card">
          <h3 class="text-lg font-heading font-bold text-text mb-2">Hometown</h3>
          <p>San Diego, California, the launch point.</p>
        </div>
        <div class="card">
          <h3 class="text-lg font-heading font-bold text-text mb-2">Nomad Chapter</h3>
          <p>Short stays across the U.S., then years of international chapters.</p>
        </div>
        <div class="card">
          <h3 class="text-lg font-heading font-bold text-text mb-2">Rooted Now</h3>
          <p>Mexico City is home base while building deeper connections.</p>
        </div>
      </div>

      <!-- US States Breakout -->
      <div class="mt-16">
        <USStateMap />
      </div>

      <!-- Mexico States Breakout -->
      <div class="mt-16">
        <MexicoStateMap />
      </div>

      <div class="mt-16 grid gap-6 lg:grid-cols-2">
        <div>
          <details class="card md:hidden">
            <summary class="flex items-center justify-between cursor-pointer text-lg font-heading font-bold">
              Countries visited
              <span class="text-sm text-text-muted">{visitedCountries.length}</span>
            </summary>
            <div class="mt-4 max-h-72 overflow-auto pr-2">
              <ul class="grid grid-cols-2 gap-y-2 text-sm text-text-muted">
                {visitedCountries.map((name) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background: var(--color-primary);"></span>
                    {name}
                  </li>
                ))}
              </ul>
            </div>
          </details>
          <div class="card hidden md:block">
            <div class="flex items-baseline justify-between mb-4">
              <h2 class="text-2xl font-heading font-bold">Countries visited</h2>
              <span class="text-sm text-text-muted">{visitedCountries.length}</span>
            </div>
            <div class="max-h-72 overflow-auto pr-2">
              <ul class="grid grid-cols-2 gap-y-2 text-sm text-text-muted">
                {visitedCountries.map((name) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background: var(--color-primary);"></span>
                    {name}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>

        <div>
          <details class="card md:hidden">
            <summary class="flex items-center justify-between cursor-pointer text-lg font-heading font-bold">
              Countries still on the list
              <span class="text-sm text-text-muted">{notVisitedCountries.length}</span>
            </summary>
            <div class="mt-4 max-h-72 overflow-auto pr-2">
              <ul class="grid grid-cols-2 gap-y-2 text-sm text-text-muted">
                {notVisitedCountries.map((name) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background: var(--color-surface-hover);"></span>
                    {name}
                  </li>
                ))}
              </ul>
            </div>
          </details>
          <div class="card hidden md:block">
            <div class="flex items-baseline justify-between mb-4">
              <h2 class="text-2xl font-heading font-bold">Countries still on the list</h2>
              <span class="text-sm text-text-muted">{notVisitedCountries.length}</span>
            </div>
            <div class="max-h-72 overflow-auto pr-2">
              <ul class="grid grid-cols-2 gap-y-2 text-sm text-text-muted">
                {notVisitedCountries.map((name) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" style="background: var(--color-surface-hover);"></span>
                    {name}
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-16 card">
        <h2 class="text-2xl font-heading font-bold mb-6">Cities lived timeline</h2>
        <div class="space-y-4">
          {livedTimeline.map((city) => (
            <div class="flex flex-col md:flex-row md:items-baseline md:justify-between border-b border-border/60 pb-4 last:border-b-0 last:pb-0">
              <div>
                <h3 class="text-lg font-heading font-bold text-text">
                  {city.city}, {city.country}
                </h3>
                {city.note && <p class="text-sm text-text-muted">{city.note}</p>}
              </div>
              <div class="text-sm text-text-muted mt-2 md:mt-0">
                {city.dates ?? 'N/A'}
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- Trip Log -->
      <div class="mt-16">
        <TripLogTimeline />
      </div>
    </div>
  </section>
</BaseLayout>
